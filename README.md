# 🛗 FreeRTOS 기반 4층 엘리베이터 시스템
## 0. 시작에  앞서
본 프로젝트는 기관에서 모든 학생들이 공통으로 수행한 프로젝트로, 다른 학생들과 크게 다르지 않습니다.                               
다만, 층의 우선순위 배열을 생성하고, 해당 배열을 기준으로 목표 층을 선택하는 알고리즘만큼은 다른 학생들과 차별화되는 부분입니다.              
다른 분들이 보시기에는 어떨지 모르지만, 부족한 저의 시선으로는 크게 애착이 가는 코드입니다.                   
해당 소스코드는 ./Src/elevator.c와 ./Inc/elevator.h 에서 확인하실 수 있습니다.              
추가로 ./Src/extint.c도 함께 보시면 좋습니다.                 
3번 항목인 개발 및 구현내용의 알고리즘 설명과 소스코드를 함께 보시면 더욱 이해하시기 편할 것입니다.                      

## 1. 개요

본 프로젝트는 **FreeRTOS**를 기반으로 한 **4층 엘리베이터 제어 시스템**입니다.
엘리베이터의 이동은 **스텝모터**로 제어되며, 층 도착 여부는 **포토센서**로 감지합니다.  
다양한 장치를 통해 운행 상태를 시각적으로 제공하고, 버튼 입력을 통해 목적층을 선택할 수 있습니다.

- **스텝모터**: 엘리베이터 운행  
- **포토센서**: 엘리베이터 층 도착 확인  
- **도트 매트릭스**: 현재 층 및 이동 방향 표시  
- **LCD**: 선택된 층 및 현재 시각 표시  
- **DS1302**: 시각 정보 추출 
- **버튼 입력 (4개)**: 1~4층 목적지 선택

---

## 2. 시스템 구성

시스템은 다음과 같은 **5개의 FreeRTOS 태스크(Task)**로 구성됩니다:

1. **엘리베이터 제어 태스크**
2. **LCD 제어 태스크**
3. **DS1302 제어 태스크**
4. **도트매트릭스 제어 태스크**
5. **Buzzer 제어 태스크**

---

## 3. 개발 및 구현 내용

### 3-1. 우선순위 기반 목표층 결정 (`update_priority`, `update_goal`)

엘리베이터는 현재 운행 방향에 따라 **우선순위 배열을 동적으로 생성**하고,  
이 배열을 기반으로 **state 변수(층 호출 상태)**를 확인하여 **목표층(goal)**을 설정합니다.

- **FORWARD (상행)**: 현재층보다 높은 층부터 순서대로  
- **BACKWARD (하행)**: 현재층보다 낮은 층부터 순서대로  
- **STOP (정지)**: 기본 순서(1층 → 4층), 단 우선순위 의미 없음

#### ✅ 예시
- 현재 층이 2층, 방향이 FORWARD → 우선순위: `[3, 4, 2, 1]`  
- 현재 층이 3층, 방향이 BACKWARD → 우선순위: `[2, 1, 3, 4]`

---

### 3-2. 버튼 이벤트 처리 (`btn_event`)

- 사용자가 버튼을 누르면 해당 층의 비트를 **`state` 변수에 설정**
- **`btn_event_flag`**를 통해 `btn_event()` 함수 호출
- 호출된 층이 있다면 `goal`을 재설정하고,
- 모든 호출이 off일 경우, 기존 방향 기준으로 임시 목표층을 설정

---

### 3-3. 도착 이벤트 처리 (`floor_event`)

- **포토센서**를 통한 외부 인터럽트 발생 시 `floor_event_flag` 설정
- `floor_event()` 함수는 현재 층과 목표 층을 비교하여 다음을 수행:

  - 층 불일치 → 우선순위만 갱신  
  - 층 일치 → `state` 비트 해제 → 우선순위/목표층 갱신 → `pause()` 호출

---

### 3-4. 일시정지 및 재개 (`pause`, `resume`)

- 도착한 층에서 일정 시간 동안 정지 (`pause_flag` 활성화)
- 정지 상태에서는 **타이머 기반 카운터**로 일정 시간 경과 후 `resume()`을 통해 자동 복귀

---

### 3-5. 스텝모터 제어 (`stepmotor_driver`)

- **8단계 시퀀스** 기반 스텝모터 제어
- 방향에 따라 다음과 같이 동작:
  - FORWARD (시계 방향): 스텝 값 증가
  - BACKWARD (반시계 방향): 스텝 값 감소
- 각 스텝마다 이전 출력 제거 (`stepmotor_all_off()`) 후 새로운 핀 출력 설정
---

## 4. 결론 및 시사점

- **우선순위 기반 목표층 선택 알고리즘** 적용
- 운행 방향에 따른 **효율적이고 유연한 층 처리 방식**
- **최대 층 변경에도 쉽게 확장 가능한 구조** 구현

해당 알고리즘은 실제로 기대한 대로 동작하였으며, 전체 시스템은 안정적으로 운행을 수행하였습니다.

---

## 👤 개발자

**장재영**
